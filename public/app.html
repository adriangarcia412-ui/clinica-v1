<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro Clínico</title>
  <style>
    :root { --gap: 12px; --accent:#0ea5e9; }
    html,body{margin:0;padding:0;background:#f7fafc;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','Noto Sans',Arial,'Apple Color Emoji','Segoe UI Emoji';color:#0f172a}
    .container{max-width:1200px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 8px 0;font-size:28px}
    .badge{display:inline-block;background:#e2f2fd;color:#075985;border:1px solid #bae6fd;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:8px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap)}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    .col-12{grid-column:span 12}
    label{display:block;font-size:13px;color:#334155;margin-bottom:6px}
    input,select,textarea{
      width:100%;box-sizing:border-box;border:1px solid #cbd5e1;border-radius:10px;
      padding:10px 12px;background:#fff;outline:none;font-size:14px
    }
    textarea{min-height:80px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px #bae6fd}
    .actions{display:flex;gap:var(--gap);margin-top:18px}
    .btn{border:none;border-radius:12px;padding:12px 18px;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-secondary{background:#e2e8f0;color:#0f172a}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:18px}
    .muted{color:#64748b}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .li{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:10px 12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="container">
    <h1>Registro Clínico <span class="badge">v1</span></h1>

    <!-- ======= TU FORMULARIO (SIN CAMBIOS EN CAMPOS/IDS) ======= -->
    <div class="card">
      <div class="grid">
        <div class="col-3">
          <label for="input-id">ID</label>
          <input id="input-id" type="text" placeholder="ID o folio">
        </div>

        <div class="col-4">
          <label for="input-fecha">Fecha/Hora ISO</label>
          <input id="input-fecha" type="text" placeholder="auto (ISO 8601)">
        </div>

        <div class="col-5">
          <label for="input-nombre">Nombre</label>
          <input id="input-nombre" type="text" placeholder="Nombre y apellidos">
        </div>

        <div class="col-3">
          <label for="input-nomina">Número de nómina</label>
          <input id="input-nomina" type="text" placeholder="Ej. A12345">
        </div>

        <div class="col-3">
          <label for="input-edad">Edad</label>
          <input id="input-edad" type="text" placeholder="Ej. 34">
        </div>

        <div class="col-3">
          <label for="select-sexo">Sexo</label>
          <select id="select-sexo">
            <option value="">Selecciona…</option>
            <option value="M">M</option>
            <option value="F">F</option>
          </select>
        </div>

        <div class="col-3">
          <label for="input-puesto">Puesto</label>
          <input id="input-puesto" type="text">
        </div>

        <div class="col-6">
          <label for="input-area-laboral">Área laboral</label>
          <input id="input-area-laboral" type="text">
        </div>

        <div class="col-6">
          <label for="input-area-incidente">Área del incidente</label>
          <input id="input-area-incidente" type="text">
        </div>

        <div class="col-6">
          <label for="input-zona">Zona del cuerpo afectada</label>
          <input id="input-zona" type="text" placeholder="Ej. mano derecha">
        </div>

        <div class="col-6">
          <label for="input-hemisferio">Hemisferio</label>
          <input id="input-hemisferio" type="text" placeholder="Izquierdo / Derecho / NA">
        </div>

        <div class="col-6">
          <label for="input-diagnostico">Diagnóstico</label>
          <input id="input-diagnostico" type="text">
        </div>

        <div class="col-6">
          <label for="input-exploracion">Exploración</label>
          <input id="input-exploracion" type="text">
        </div>

        <div class="col-6">
          <label for="input-motivo">Motivo</label>
          <input id="input-motivo" type="text">
        </div>

        <div class="col-6">
          <label for="input-antecedentes">Antecedentes</label>
          <input id="input-antecedentes" type="text">
        </div>

        <div class="col-6">
          <label for="input-clasificacion">Clasificación del accidente</label>
          <input id="input-clasificacion" type="text" placeholder="FAT/LTI/MTC/FAC/UA&C">
        </div>

        <div class="col-6">
          <label for="input-seguimiento">Seguimiento (cita)</label>
          <input id="input-seguimiento" type="text" placeholder="dd/mm/aaaa o texto">
        </div>

        <div class="col-12">
          <label for="input-indicaciones">Indicaciones / Tratamiento</label>
          <textarea id="input-indicaciones" placeholder="Medicamentos, reposo, recomendaciones…"></textarea>
        </div>

        <div class="col-12 actions">
          <button id="btn-close" class="btn btn-primary">Cerrar caso → hoja “Clínica”</button>
          <button id="btn-cloud" class="btn btn-secondary">Guardar en la nube</button>
        </div>
      </div>
    </div>

    <!-- ======= Casos en la nube (pendientes) ======= -->
    <div class="card" style="margin-top:18px">
      <div class="row">
        <h2 style="margin:0">Casos en la nube (pendientes)</h2>
        <span class="badge">Nube temporal</span>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btn-refresh" class="btn btn-secondary">Actualizar lista</button>
        <span id="cloud-msg" class="muted"></span>
      </div>
      <div id="cloud-list" class="list"></div>
    </div>
  </div>

  <script>
    // === Helpers front ===
    function valueOf(id){ return document.getElementById(id)?.value?.trim() || ""; }

    function collectClinicaData(){
      return {
        id: valueOf("input-id"),
        fecha_iso: valueOf("input-fecha") || new Date().toISOString(),
        nombre: valueOf("input-nombre"),
        numero_nomina: valueOf("input-nomina"),
        edad: valueOf("input-edad"),
        sexo: document.getElementById("select-sexo")?.value || "",
        puesto: valueOf("input-puesto"),
        area_laboral: valueOf("input-area-laboral"),
        area_incidente: valueOf("input-area-incidente"),
        zona_cuerpo: valueOf("input-zona"),
        hemisferio: valueOf("input-hemisferio"),
        diagnostico: valueOf("input-diagnostico"),
        exploracion: valueOf("input-exploracion"),
        motivo: valueOf("input-motivo"),
        antecedentes: valueOf("input-antecedentes"),
        clasificacion: valueOf("input-clasificacion"),
        seguimiento: valueOf("input-seguimiento"),
        indicaciones: valueOf("input-indicaciones"),
      };
    }

    async function api(action, data){
      const res = await fetch(`/api/gsheet?action=${encodeURIComponent(action)}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data || {})
      });
      // Leemos una ÚNICA vez, evitando el error “body stream already read”
      const text = await res.text();
      try {
        const j = JSON.parse(text);
        return j;
      } catch {
        // Si no es JSON (GAS devolvió HTML), devolvemos error legible
        return { ok:false, error: text.slice(0, 600) };
      }
    }

    function alertMsg(msg){
      // alert simple manteniendo tu UX actual
      window.alert(msg);
    }

    // === Botón: Guardar en la nube ===
    document.getElementById("btn-cloud").addEventListener("click", async () => {
      const data = collectClinicaData();
      const r = await api("clinica_cloud_save", { data });
      if (r?.ok) {
        alertMsg("Pendiente guardado: OK");
        refreshCloud();
      } else {
        alertMsg("No se pudo guardar en la nube: " + (r?.error || "Error desconocido"));
      }
    });

    // === Botón: Cerrar caso → hoja “Clínica” ===
    document.getElementById("btn-close").addEventListener("click", async () => {
      const data = collectClinicaData();
      const r = await api("clinica_close", { data });
      if (r?.ok) {
        alertMsg("Caso cerrado y enviado a hoja 'Clínica': OK");
      } else {
        alertMsg("No se pudo cerrar el caso: " + (r?.error || "Error desconocido"));
      }
    });

    // === Listar pendientes ===
    async function refreshCloud(){
      const holder = document.getElementById("cloud-list");
      const msg = document.getElementById("cloud-msg");
      holder.innerHTML = "";
      msg.textContent = "Cargando…";
      const r = await api("clinica_list_pending", {});
      msg.textContent = "";

      if (!r?.ok) {
        msg.textContent = "No se pudo listar ( " + (r?.error || "Error") + " ).";
        return;
      }
      const items = Array.isArray(r.items) ? r.items : [];
      if (!items.length){
        holder.innerHTML = `<div class="muted">No hay pendientes en la nube.</div>`;
        return;
      }
      const frag = document.createDocumentFragment();
      items.forEach((it) => {
        const d = document.createElement("div");
        d.className = "li";
        d.innerHTML = `
          <div class="row">
            <strong>${(it.id || "").toString().slice(0,24) || "(sin id)"} </strong>
            <span class="muted">· ${it.fecha_iso || ""}</span>
          </div>
          <div class="muted">${(it.nombre || "").toString().slice(0,120)}</div>
        `;
        frag.appendChild(d);
      });
      holder.appendChild(frag);
    }
    document.getElementById("btn-refresh").addEventListener("click", refreshCloud);

    // Carga inicial “suave” (si GAS está caído, no rompe)
    setTimeout(() => { refreshCloud().catch(()=>{}); }, 300);
  </script>
</body>
</html>
