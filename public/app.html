<!-- ============== CASOS EN LA NUBE (PENDIENTES) – BLOQUE COMPLETO ============== -->
<section id="clinica-cloud-root" style="margin:48px 0 64px">
  <h2 style="font-size:28px; font-weight:800; margin:0 0 8px">Casos en la nube (pendientes)</h2>
  <p id="clinica-cloud-empty" style="margin:0 0 16px; color:#6b7280">No hay pendientes en la nube.</p>

  <div style="display:flex; gap:12px; align-items:center; margin-bottom:16px">
    <button id="clinica-cloud-refresh" type="button"
            style="background:#0ea5e9; color:white; border:0; padding:10px 14px; border-radius:10px; cursor:pointer">
      Actualizar lista
    </button>
    <span id="clinica-cloud-status" style="font-size:13px; color:#6b7280"></span>
  </div>

  <div style="overflow:auto; border:1px solid #e5e7eb; border-radius:10px">
    <table id="clinica-cloud-table" style="width:100%; border-collapse:collapse; min-width:920px">
      <thead style="background:#f8fafc">
        <tr>
          <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #e5e7eb">ID</th>
          <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #e5e7eb">Fecha</th>
          <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #e5e7eb">Hora</th>
          <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #e5e7eb">Nombre</th>
          <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #e5e7eb"># Nómina</th>
          <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #e5e7eb">Área</th>
          <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #e5e7eb">Puesto</th>
          <th style="text-align:left; padding:10px 12px; border-bottom:1px solid #e5e7eb">Acciones</th>
        </tr>
      </thead>
      <tbody id="clinica-cloud-tbody"></tbody>
    </table>
  </div>
</section>

<script>
(() => {
  // ====================== CONFIG ======================
  const API = '/api/gsheet'; // tu endpoint actual

  // IDs de campos actuales del formulario (ajusta si alguno difiere)
  const FIELDS = {
    id:                 'input-id',
    fecha_iso:          'input-fecha',
    nombre:             'input-nombre',
    numero_nomina:      'input-nomina',
    edad:               'input-edad',
    sexo:               'select-sexo',
    area_laboral:       'input-area-laboral',
    area_incidente:     'input-area-incidente',
    puesto:             'input-puesto',
    zona_cuerpo:        'input-zona',
    diagnostico:        'input-diagnostico',
    exploracion:        'input-exploracion',
    motivo:             'input-motivo',
    antecedentes:       'input-antecedentes',
    hemisferio:         'input-hemisferio',
    clasificacion:      'input-clasificacion',
    indicaciones:       'input-indicaciones',
    seguimiento:        'input-seguimiento'
  };

  // ================ Utilidades =================
  async function postJSON(action, data = {}) {
    const res = await fetch(API, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ action, data })
    });
    let out;
    try { out = await res.json(); } catch(e) { out = { ok:false, error:'Respuesta inválida' }; }
    if (!out || out.ok === false) throw new Error(out?.error || 'Error desconocido');
    return out;
  }

  const $ = (id) => document.getElementById(id);
  const setStatus = (m) => { const el = $('clinica-cloud-status'); if (el) el.textContent = m || ''; };

  function getValue(id){ const el = $(id); return el ? String(el.value ?? '').trim() : ''; }
  function setValue(id, v){
    const el = $(id); if (!el) return;
    if (el.tagName === 'SELECT') { el.value = v ?? ''; el.dispatchEvent(new Event('change')); }
    else { el.value = v ?? ''; el.dispatchEvent(new Event('input')); }
  }

  function collectForm() {
    if (typeof window.clinicaFormData === 'function') return window.clinicaFormData();
    return {
      id:                getValue(FIELDS.id),
      fecha_iso:         getValue(FIELDS.fecha_iso),
      nombre:            getValue(FIELDS.nombre),
      numero_nomina:     getValue(FIELDS.numero_nomina),
      edad:              getValue(FIELDS.edad),
      sexo:              getValue(FIELDS.sexo),
      area_laboral:      getValue(FIELDS.area_laboral),
      area_incidente:    getValue(FIELDS.area_incidente),
      puesto:            getValue(FIELDS.puesto),
      zona_cuerpo:       getValue(FIELDS.zona_cuerpo),
      diagnostico:       getValue(FIELDS.diagnostico),
      exploracion:       getValue(FIELDS.exploracion),
      motivo:            getValue(FIELDS.motivo),
      antecedentes:      getValue(FIELDS.antecedentes),
      hemisferio:        getValue(FIELDS.hemisferio),
      clasificacion:     getValue(FIELDS.clasificacion),
      indicaciones:      getValue(FIELDS.indicaciones),
      seguimiento:       getValue(FIELDS.seguimiento)
    };
  }

  function fillForm(data = {}) {
    if (typeof window.clinicaFillForm === 'function') { window.clinicaFillForm(data); return; }
    setValue(FIELDS.id,             data.id);
    setValue(FIELDS.fecha_iso,      data.fecha_iso);
    setValue(FIELDS.nombre,         data.nombre);
    setValue(FIELDS.numero_nomina,  data.numero_nomina);
    setValue(FIELDS.edad,           data.edad);
    setValue(FIELDS.sexo,           data.sexo);
    setValue(FIELDS.area_laboral,   data.area_laboral);
    setValue(FIELDS.area_incidente, data.area_incidente);
    setValue(FIELDS.puesto,         data.puesto);
    setValue(FIELDS.zona_cuerpo,    data.zona_cuerpo);
    setValue(FIELDS.diagnostico,    data.diagnostico);
    setValue(FIELDS.exploracion,    data.exploracion);
    setValue(FIELDS.motivo,         data.motivo);
    setValue(FIELDS.antecedentes,   data.antecedentes);
    setValue(FIELDS.hemisferio,     data.hemisferio);
    setValue(FIELDS.clasificacion,  data.clasificacion);
    setValue(FIELDS.indicaciones,   data.indicaciones);
    setValue(FIELDS.seguimiento,    data.seguimiento);
  }

  // ================ Render tabla =================
  function renderTable(items = []) {
    const tbody = $('clinica-cloud-tbody');
    const empty = $('clinica-cloud-empty');
    if (!tbody) return;

    tbody.innerHTML = '';
    if (!items.length) { if (empty) empty.style.display = 'block'; return; }
    if (empty) empty.style.display = 'none';

    for (const it of items) {
      const tr = document.createElement('tr');
      const td = (t) => { const c = document.createElement('td'); c.style.padding='10px 12px'; c.style.borderBottom='1px solid #e5e7eb'; c.textContent = t ?? ''; return c; };

      tr.appendChild(td(it.id));
      tr.appendChild(td(it.fecha || ''));
      tr.appendChild(td(it.hora || ''));
      tr.appendChild(td(it.nombre || ''));
      tr.appendChild(td(it.numero_nomina || ''));
      tr.appendChild(td(it.area_laboral || ''));
      tr.appendChild(td(it.puesto || ''));

      const actions = document.createElement('td');
      actions.style.padding='10px 12px';
      actions.style.borderBottom='1px solid #e5e7eb';
      actions.style.whiteSpace='nowrap';
      actions.style.display='flex';
      actions.style.gap='8px';

      const bLoad = document.createElement('button');
      bLoad.textContent = 'Cargar en formulario';
      bLoad.type='button';
      bLoad.style.cssText='background:#64748b;color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer';
      bLoad.addEventListener('click', () => fillForm(it));

      const bClose = document.createElement('button');
      bClose.textContent = 'Enviar y cerrar';
      bClose.type='button';
      bClose.style.cssText='background:#10b981;color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer';
      bClose.addEventListener('click', async () => {
        try {
          setStatus('Enviando caso...');
          const out = await postJSON('clinica_close', it);
          alert(`Caso cerrado: ${out.id || it.id || 'OK'}`);
          await refresh();
        } catch (err) {
          alert(`Error al cerrar: ${err.message}`);
        } finally { setStatus(''); }
      });

      actions.appendChild(bLoad);
      actions.appendChild(bClose);
      tr.appendChild(actions);
      tbody.appendChild(tr);
    }
  }

  // ================ Carga de pendientes =================
  async function refresh() {
    try {
      setStatus('Consultando pendientes...');
      // Asegúrate que tu backend tenga esta acción.
      const out = await postJSON('clinica_list_pending', {});
      renderTable(out.items || out.rows || []);
    } catch (err) {
      console.warn(err);
      renderTable([]);
    } finally {
      setStatus('');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const btn = $('clinica-cloud-refresh');
    if (btn) btn.addEventListener('click', refresh);
    refresh();
  });
})();
</script>
<!-- ============ FIN CASOS EN LA NUBE (PENDIENTES) – BLOQUE COMPLETO ============ -->
