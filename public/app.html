<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro Clínico</title>
  <style>
    :root { --gap: 12px; --accent:#0ea5e9; }
    html,body{margin:0;padding:0;background:#f7fafc;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','Noto Sans',Arial,'Apple Color Emoji','Segoe UI Emoji';color:#0f172a}
    .container{max-width:1200px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 8px 0;font-size:28px}
    .badge{display:inline-block;background:#e2f2fd;color:#075985;border:1px solid #bae6fd;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:8px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap)}
    .col-6{grid-column:span 6}
    .col-5{grid-column:span 5}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    .col-12{grid-column:span 12}
    label{display:block;font-size:13px;color:#334155;margin-bottom:6px}
    input,select,textarea{
      width:100%;box-sizing:border-box;border:1px solid #cbd5e1;border-radius:10px;
      padding:10px 12px;background:#fff;outline:none;font-size:14px
    }
    textarea{min-height:80px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px #bae6fd}
    .actions{display:flex;gap:var(--gap);margin-top:18px;flex-wrap:wrap}
    .btn{border:none;border-radius:12px;padding:12px 18px;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-secondary{background:#e2e8f0;color:#0f172a}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:18px}
    /* Casos en la nube */
    .cloud-head{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .table{width:100%;border-collapse:collapse;margin-top:12px}
    .table th,.table td{border-bottom:1px solid #e2e8f0;padding:10px;font-size:14px;text-align:left}
    .muted{color:#64748b}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#e2f2fd;color:#075985;border:1px solid #bae6fd;font-size:12px}
    .btn-danger{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    .btn-ghost{background:#f1f5f9;color:#0f172a}
  </style>
</head>
<body>
  <div class="container">
    <h1>Registro Clínico <span class="badge">v1</span></h1>

    <!-- FORMULARIO (sin cambios) -->
    <div class="card">
      <div class="grid">
        <div class="col-3">
          <label for="input-id">ID</label>
          <input id="input-id" type="text" placeholder="ID o folio">
        </div>

        <div class="col-4">
          <label for="input-fecha">Fecha/Hora ISO</label>
          <input id="input-fecha" type="text" placeholder="auto (ISO 8601)">
        </div>

        <div class="col-5">
          <label for="input-nombre">Nombre</label>
          <input id="input-nombre" type="text" placeholder="Nombre y apellidos">
        </div>

        <div class="col-3">
          <label for="input-nomina">Número de nómina</label>
          <input id="input-nomina" type="text" placeholder="Ej. A12345">
        </div>

        <div class="col-3">
          <label for="input-edad">Edad</label>
          <input id="input-edad" type="text" placeholder="Ej. 34">
        </div>

        <div class="col-3">
          <label for="select-sexo">Sexo</label>
          <select id="select-sexo">
            <option value="">Selecciona…</option>
            <option value="M">M</option>
            <option value="F">F</option>
          </select>
        </div>

        <div class="col-3">
          <label for="input-puesto">Puesto</label>
          <input id="input-puesto" type="text">
        </div>

        <div class="col-6">
          <label for="input-area-laboral">Área laboral</label>
          <input id="input-area-laboral" type="text">
        </div>

        <div class="col-6">
          <label for="input-area-incidente">Área del incidente</label>
          <input id="input-area-incidente" type="text">
        </div>

        <div class="col-6">
          <label for="input-zona">Zona del cuerpo afectada</label>
          <input id="input-zona" type="text" placeholder="Ej. mano derecha">
        </div>

        <div class="col-6">
          <label for="input-hemisferio">Hemisferio</label>
          <input id="input-hemisferio" type="text" placeholder="Izquierdo / Derecho / NA">
        </div>

        <div class="col-6">
          <label for="input-diagnostico">Diagnóstico</label>
          <input id="input-diagnostico" type="text">
        </div>

        <div class="col-6">
          <label for="input-exploracion">Exploración</label>
          <input id="input-exploracion" type="text">
        </div>

        <div class="col-6">
          <label for="input-motivo">Motivo</label>
          <input id="input-motivo" type="text">
        </div>

        <div class="col-6">
          <label for="input-antecedentes">Antecedentes</label>
          <input id="input-antecedentes" type="text">
        </div>

        <div class="col-6">
          <label for="input-clasificacion">Clasificación del accidente</label>
          <input id="input-clasificacion" type="text" placeholder="FAT/LTI/MTC/FAC/UA&C">
        </div>

        <div class="col-6">
          <label for="input-seguimiento">Seguimiento (cita)</label>
          <input id="input-seguimiento" type="text" placeholder="dd/mm/aaaa o texto">
        </div>

        <div class="col-12">
          <label for="input-indicaciones">Indicaciones / Tratamiento</label>
          <textarea id="input-indicaciones" placeholder="Medicamentos, reposo, recomendaciones…"></textarea>
        </div>

        <div class="col-12 actions">
          <button id="btn-guardar-pend" class="btn btn-secondary">Guardar (Pendiente)</button>
          <button id="btn-cerrar-caso" class="btn btn-primary">Cerrar caso → hoja “Clínica”</button>
          <!-- NUEVO botón explícito, mismo efecto que Guardar (Pendiente) -->
          <button id="btn-guardar-nube" class="btn btn-ghost">Guardar en la nube</button>
        </div>
      </div>
    </div>

    <!-- CASOS EN LA NUBE (pendientes) -->
    <div class="card" style="margin-top:20px">
      <div class="cloud-head">
        <h2 style="margin:0">Casos en la nube (pendientes) <span class="pill">Nube temporal</span></h2>
        <div style="display:flex;gap:10px">
          <button id="btn-refresh" class="btn btn-primary">Actualizar lista</button>
        </div>
      </div>
      <div id="cloud-empty" class="muted" style="margin-top:10px">No hay pendientes en la nube.</div>
      <table id="cloud-table" class="table" style="display:none">
        <thead>
          <tr>
            <th style="width:140px">ID</th>
            <th>Nombre</th>
            <th style="width:180px">Fecha</th>
            <th style="width:220px">Acciones</th>
          </tr>
        </thead>
        <tbody id="cloud-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Bridge existente: engancha Guardar (Pendiente) / Cerrar caso -->
  <script src="/clinica-bridge.js"></script>

  <!-- MÓDULO EN PÁGINA: reusa el mismo backend con las 3 acciones válidas -->
  <script>
    // Punto único de API (mismo que usa el bridge)
    const API = '/api/gsheet';

    // 1) Un colector común para tu formulario
    //    El bridge lo detecta si existe window.clinicaFormData()
    window.clinicaFormData = function() {
      const g = id => document.getElementById(id);
      return {
        id: g('input-id')?.value?.trim() || '',
        fecha_iso: g('input-fecha')?.value?.trim() || new Date().toISOString(),
        nombre: g('input-nombre')?.value?.trim() || '',
        numero_nomina: g('input-nomina')?.value?.trim() || '',
        edad: g('input-edad')?.value?.trim() || '',
        sexo: g('select-sexo')?.value || '',
        puesto: g('input-puesto')?.value?.trim() || '',
        area_laboral: g('input-area-laboral')?.value?.trim() || '',
        area_incidente: g('input-area-incidente')?.value?.trim() || '',
        zona_cuerpo: g('input-zona')?.value?.trim() || '',
        diagnostico: g('input-diagnostico')?.value?.trim() || '',
        exploracion: g('input-exploracion')?.value?.trim() || '',
        motivo: g('input-motivo')?.value?.trim() || '',
        antecedentes: g('input-antecedentes')?.value?.trim() || '',
        hemisferio: g('input-hemisferio')?.value?.trim() || '',
        clasificacion: g('input-clasificacion')?.value?.trim() || '',
        seguimiento: g('input-seguimiento')?.value?.trim() || '',
        indicaciones: g('input-indicaciones')?.value?.trim() || ''
      };
    };

    async function postJSON(action, data) {
      const res = await fetch(API, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ action, data })
      });
      const j = await res.json();
      if (!j.ok) throw new Error(j.error || 'Error desconocido');
      return j;
    }

    // 2) Guardar en la nube (usa la acción que SÍ existe en tu backend)
    async function cloudSave() {
      try {
        const data = window.clinicaFormData();
        const out = await postJSON('clinica_save_pending', data);
        alert(`Pendiente guardado: ${out.id || 'OK'}`);
        await cloudList(); // refresca
      } catch (e) {
        alert('No se pudo guardar en la nube: ' + e.message);
      }
    }

    // 3) Listar pendientes
    async function cloudList() {
      try {
        const out = await postJSON('clinica_list_pending', {});
        const rows = Array.isArray(out.rows) ? out.rows : (out.data || out.list || []);
        renderCloud(rows);
      } catch (e) {
        // Si la acción no existe aún en backend, no rompemos la UI
        document.getElementById('cloud-empty').textContent =
          'No se pudo listar (¿falta acción clinica_list_pending en el backend?).';
        document.getElementById('cloud-empty').style.display = '';
        document.getElementById('cloud-table').style.display = 'none';
      }
    }

    // 4) Eliminar pendiente
    async function cloudDelete(id) {
      if (!confirm('¿Eliminar este pendiente de la nube?')) return;
      try {
        await postJSON('clinica_delete_pending', { id });
        await cloudList();
      } catch (e) {
        alert('No se pudo eliminar: ' + e.message);
      }
    }

    // 5) Reanudar: copia los datos a tu formulario
    function cloudResume(row) {
      const g = id => document.getElementById(id);
      // Acepta tanto objetos planos como row.data
      const d = row.data || row;
      if (!d) return;

      g('input-id').value = d.id || row.id || '';
      g('input-fecha').value = d.fecha_iso || d.fecha || '';
      g('input-nombre').value = d.nombre || '';
      g('input-nomina').value = d.numero_nomina || d.nomina || '';
      g('input-edad').value = d.edad || '';
      g('select-sexo').value = d.sexo || '';
      g('input-puesto').value = d.puesto || '';
      g('input-area-laboral').value = d.area_laboral || d.area || '';
      g('input-area-incidente').value = d.area_incidente || '';
      g('input-zona').value = d.zona_cuerpo || d.zona || '';
      g('input-hemisferio').value = d.hemisferio || '';
      g('input-diagnostico').value = d.diagnostico || '';
      g('input-exploracion').value = d.exploracion || '';
      g('input-motivo').value = d.motivo || '';
      g('input-antecedentes').value = d.antecedentes || '';
      g('input-clasificacion').value = d.clasificacion || '';
      g('input-seguimiento').value = d.seguimiento || '';
      g('input-indicaciones').value = d.indicaciones || '';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Render de la tabla
    function renderCloud(rows) {
      const empty = document.getElementById('cloud-empty');
      const table = document.getElementById('cloud-table');
      const tbody = document.getElementById('cloud-tbody');

      if (!rows || rows.length === 0) {
        empty.textContent = 'No hay pendientes en la nube.';
        empty.style.display = '';
        table.style.display = 'none';
        tbody.innerHTML = '';
        return;
      }

      empty.style.display = 'none';
      table.style.display = '';
      tbody.innerHTML = rows.map(r => {
        const d = r.data || r;
        const id = d.id || r.id || '(sin id)';
        const nombre = (d.nombre || '').toString().slice(0, 60);
        const fecha = d.fecha_iso || d.fecha || '';
        return `
          <tr>
            <td>${id}</td>
            <td>${nombre || '-'}</td>
            <td>${fecha || '-'}</td>
            <td>
              <button class="btn btn-secondary" onclick='(${cloudResume.toString()})(${JSON.stringify(r)})'>Reanudar</button>
              <button class="btn btn-danger" onclick="cloudDelete('${id.replace(/"/g,'\\"')}')">Eliminar</button>
            </td>
          </tr>`;
      }).join('');
    }

    // Eventos
    document.getElementById('btn-guardar-nube').addEventListener('click', cloudSave);
    document.getElementById('btn-refresh').addEventListener('click', cloudList);

    // Carga inicial (no rompe si aún no existe la acción listar)
    cloudList();
  </script>
</body>
</html>
