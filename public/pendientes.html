<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pendientes — Registro Clínico</title>
  <link rel="icon" href="data:," />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;margin:0;background:#f6f8fb;color:#0f172a}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px 20px;background:#0ea5e9;color:white}
    header h1{font-size:18px;margin:0}
    main{padding:20px;max-width:1100px;margin:0 auto}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button,a.button{border:0;border-radius:8px;padding:10px 14px;background:#0ea5e9;color:#fff;cursor:pointer}
    a.button{text-decoration:none;display:inline-block}
    button.secondary{background:#e2e8f0;color:#0f172a}
    table{width:100%;border-collapse:collapse;margin-top:14px;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    th,td{padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:14px;text-align:left;vertical-align:top}
    th{background:#f8fafc;color:#334155}
    tr:last-child td{border-bottom:0}
    .empty{padding:14px;background:#fff;border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .muted{color:#64748b}
    .id{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#e2e8f0;color:#0f172a;font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>Pendientes (local)</h1>
    <div class="actions">
      <a class="button" href="/app.html">Nuevo caso</a>
      <button class="secondary" id="btnClear">Vaciar lista local</button>
      <button class="secondary" id="btnReload">Recargar</button>
    </div>
  </header>

  <main>
    <div id="root"></div>
  </main>

  <script>
    const KEY = 'clinica_pendientes';

    function readPendientes(){
      try{
        return JSON.parse(localStorage.getItem(KEY) || '[]');
      }catch(_){ return []; }
    }
    function writePendientes(arr){
      localStorage.setItem(KEY, JSON.stringify(arr || []));
    }
    function timeAgo(ts){
      const d = new Date(ts);
      if (isNaN(d)) return '';
      return d.toLocaleString();
    }
    function loadIntoForm(rec){
      // Guarda un buffer para el formulario y redirige.
      localStorage.setItem('clinica_pendingToLoad', JSON.stringify(rec));
      window.location.href = '/app.html';
    }
    function removeById(id){
      const arr = readPendientes().filter(r => (r.id||'').trim() !== (id||'').trim());
      writePendientes(arr);
      render();
    }
    function render(){
      const root = document.getElementById('root');
      const data = readPendientes();

      if (!data.length){
        root.innerHTML = `
          <div class="empty">
            <div class="muted">No hay pendientes guardados en este navegador.</div>
            <div class="muted" style="margin-top:6px">Cuando pulses <b>“Guardar (Pendiente)”</b> en <a href="/app.html">/app.html</a>, aquí aparecerá una copia local.</div>
          </div>`;
        return;
      }

      const rows = data.map(r => `
        <tr>
          <td class="id">${(r.id||'').replace(/</g,'&lt;')}</td>
          <td>${(r.nombre||'').replace(/</g,'&lt;')}</td>
          <td>${(r.numero_nomina||'').replace(/</g,'&lt;')}</td>
          <td><span class="badge">${(r.sexo||'NA')}</span></td>
          <td class="muted">${timeAgo(r._ts || Date.now())}</td>
          <td>
            <button onclick='(${loadIntoForm})(JSON.parse(this.dataset.payload))' data-payload='${JSON.stringify(r)}'>Cargar</button>
            <button class="secondary" onclick='(${removeById})(${JSON.stringify(r.id||"")})'>Eliminar</button>
          </td>
        </tr>
      `).join('');

      root.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Nómina</th>
              <th>Sexo</th>
              <th>Guardado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    document.getElementById('btnClear').addEventListener('click', () => {
      if (confirm('¿Vaciar la lista local de pendientes?')) { writePendientes([]); render(); }
    });
    document.getElementById('btnReload').addEventListener('click', render);
    render();
  </script>
</body>
</html>
